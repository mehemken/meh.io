<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/static/images/Favicon.ico">
    <link rel="icon" href="/static/images/Favicon.ico">

    <title>mehemken.io</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/bootstrap/bootstrap-3.3.7-dist/css/bootstrap.min.css " rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/sticky-footer-navbar.css" rel="stylesheet">
<style>
.bg-4 {
    background-color: #f5f5f5;
}
</style>
  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">mehemken.io</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
              <li><a href="/blog/">Blog</a></li>
              <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More stuff<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li class="dropdown-header">Professional</li>
                <li><a href="https://www.linkedin.com/in/mehemken">LinkedIn</a></li>
                <li><a href="https://github.com/mehemken">GitHub</a></li>
                <li><a href="http://stackoverflow.com/cv/mehemken">StackOverflow CV</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Social</li>
                <li><a href="https://twitter.com/mehemken">Twitter</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <!-- Begin page content -->
    <div class="container">
        <div class="row">
	    <div class="col-xs-8 col-sm-8 col-lg-8">
            <h1>Getting started w/ AWS CLI</h1>
            <p class="lead">13 May 2017</p>
            <hr>
            <p>This post is in progress...</p>
<p>You can find the complete CloudFormation <a href="https://gist.github.com/mehemken/f9e2c5285f91f2afe7cba5fd49d85893" title="TaaG">template as a gist</a> on my GitHub page.</p>
<h2>Installing the AWS CLI</h2>
<p>First and foremost, I recommend the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" title="Installing the AWS CLI">AWS CLI Installation Instructions</a> provided by Amazon. They are pretty straightforward (if you're on linux). I can only vouch for the Linux version of this as I have not tried it on Windows.</p>
<p>If you are working on a Windows system you won't be able to follow along in this tutorial. I recommend you spin up a VM or dual boot your computer. Or better yet, spin up an EC2 instance and connect to it. I recommend using the Amazon Linux AMI as it comes with the AWS CLI preinstalled [citation needed]. If you have Ubuntu and Python 2.6.5+ or Python 3.3+ installation is as easy as</p>
<pre><code>$ pip install --upgrade --user awscli
</code></pre>
<p>For more info on the flags there see the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" title="Installing the AWS CLI">AWS Docs</a> on it. After you've installed it you may need to add the tool to your PATH. The default directory where the CLI is installed is <code>~/.local/bin</code>, but double check first.</p>
<pre><code>$ ls ~/.local/bin
aws                 aws_zsh_completer.sh  ...
aws_bash_completer  jp.py                 ...
...
$ export PATH=~/.local/bin:$PATH
</code></pre>
<p>If you don't see the <code>aws</code> binary in that directory, you'll have to do some troubleshooting. See the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" title="Installing the AWS CLI">docs</a>. Another thing you might find useful is <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-command-completion.html" title="AWS CLI autocompletion guide">autocompletion</a>. This should be as easy as adding a line to your terminal emulator's rc file.</p>
<p>If you don't know what terminal you have, you're most likely using bash. In your favorite editor open <code>~/.bashrc</code>. For those new to a Linux environment, it is a hidden file so you may not be able to see it by default in your file finder. There should be an option somewhere to reveal it. Add this to the end of the file</p>
<pre><code>complete -C '&lt;installation directory&gt;/aws_completer' aws
</code></pre>
<p>Where <code>&lt;installation directory&gt;</code> is <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-command-completion.html#cli-command-completion-completer" title="Locate the AWS Completer">the directory where pip installed the AWS CLI</a>. I happen to be using the zsh completer and I didn't run into any issues with the instructions on the AWS <a href="http://docs.aws.amazon.com/cli/latest/userguide/cli-command-completion.html" title="AWS CLI autocompletion guide">autocompletion Docs</a>.</p>
<hr />
<h2>First steps with the CLI</h2>
<p>What you'll get out of this tutorial is a hello-world type automation script. We'll be creating an EC2 instance and an S3 bucket. Then we'll add some IAM security controls on them.</p>
<p>Funny enough, you can't just do something like</p>
<pre><code>$ aws EC2 launch instance
</code></pre>
<p>That does not exist. We will have to write a <a href="https://aws.amazon.com/documentation/cloudformation/" title="CloudFormation Docs">CloudFormation</a> template. These are json or yaml files that describe the resources you want to launch in AWS. Get your favorite editor and write this:</p>
<pre><code>// file: hello-bucket.json
{
    "Resources" : {
        "HelloBucket" : {
            "Type" : "AWS::S3::Bucket"
        }
    }
}
</code></pre>
<p>Here, you are defining a resource and its name is HelloBucket. It is an S3 bucket. We can now use the CLI to launch this.</p>
<p>You will want to see what's going on here. Before you do anything, open up your AWS console. I'm assuming you know how to navigate it. In the Services dropdown under Storage, pick S3. Notice how nothing there is named HelloBucket.</p>
<p>Now enter the following command. Make sure you're in the directory that contains the file.</p>
<pre><code># Line breaks included for clarity.
# Don't include them in your terminal.

$ aws cloudformation deploy
    --template-file hello-bucket.json
    --stack-name helloBucketStack
</code></pre>
<p>It will take a minute to set things up, but once it's done, click the circular refresh arrows on the AWS S3 page. You should see something like <code>hellobucketstack-hellobucket-1imwav37498hg</code>.</p>
<p>The beauty of this is that AWS treats this bucket as part of a template. If you tear down the template, you tear down everyting. (You can choose to keep buckets when taking down a CloudFormation template, but that's outside the scope of this article.)</p>
<pre><code>$ aws cloudformation describe-stacks
</code></pre>
<p>This will show you some descriptive things about your stack. If your stack failed to complete, you'll see some helpful hints in the output. For now, let's get rid of it and create something new.</p>
<pre><code>$ aws cloudformation delete-stack
    --stack-name helloBucketStack
</code></pre>
<p>Let's go back to the template and add a resource. You will notice that I've added a "<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html#aws-resource-ec2-instance-syntax" title="EC2 Syntax">Properties</a>" list. These are the two required properties for an EC2 instance to launch. If you do not include them, your stack will begin to launch, but it will fail and eventually it will be rolled back. The tag property is not required but it's always nice to name your stuff.</p>
<pre><code>// file: hello-bucket.json
{
    "Resources" : {
        "HelloBucket" : {
            "Type" : "AWS::S3::Bucket"
        },
        "HelloT2micro" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "InstanceType" : "t2.micro",
                "ImageId" : "ami-efd0428f"
                "Tags" : [ {"Key":"Name", "Value":"El tagerino"} ]
            }
        }
    }
}
</code></pre>
<p>The ImageId I'm using here is the Ubuntu 16.04 image for us-west-2 (citation needed).</p>
<hr />
<h3>Basic security with IAM Roles</h3>
<p>You might say, well that's not secure at all. Let's add some roles to that. The first thing we'll need to do is create a new role.</p>
<p>There seems to be two ways to go about this. One way is to create the role within your CloudFormation template and the other is to use the <code>aws iam</code> command. The latter option seems a bit manual. Why not include it in the CloudFormation template so we can make it repeatable?</p>
<p>To create a key use this command:</p>
<h3>Notes and next steps</h3>
<p>To do<br />
- Secure the EC2 with IAM and some pem keys<br />
- Create a pem key
- Include the pem key in the CloudFormation template for the EC2 instance </p>
<p>Order of operations...</p>
<p>The flow of the article is not ideal at the moment. Perhaps I can add chucks to the CF template in this order:</p>
<ol>
<li>EC2</li>
<li>S3</li>
<li>Security Group (Key pair)</li>
<li>IAM::Role</li>
<li>IAM::InstanceProfile</li>
</ol>
<p>In this order it might be easier to digest.</p>
<p>In that spirit, here is the rewrite.</p>
<hr />
<h3>First steps with the cli</h3>
<p>One of the simplest things you can do is create a key pair. For those completely new to AWS, key pairs are used to connect to an EC2 instance securely. The CLI has a command for this.</p>
<pre><code>aws ec2 create-key-pair \
    --key-name MyKeyPair \
    --query 'KeyMaterial' \
    --output text &gt; MyKeyPair.pem
</code></pre>
<p>It looks like there are a lot of flags here. They are all necessary. The <code>create-key-pair</code> command creates the key and keeps it somewhere you can access it from your AWS account. The <code>--key-name</code> is required so you can identify the key. The command will return a few different parts of the key including the fingerprint and name etc. in json format. You don't need all that. You just need the KeyMaterial, hence the <code>--query</code> flag.finally, you need to store the key on your machine so you can use it to log in to your instance. The <code>--output</code> flag ensures you receive the KeyMaterial in the proper format. Finally, if you're not familiar with bash, this line</p>
<pre><code>... &gt; MyKeyPair.pem
</code></pre>
<p>just takes the output of the previous command and creates a new file with the content. This way, you have a key ready to use.</p>
<h4>Start an EC2 Instance</h4>
<p>Funny enough,</p>
<pre><code>$ aws ec2 instance create   # This doesn't exist
</code></pre>
<p>You need a little more information. A great way to provide this information is in a json document.</p>
<pre><code>// automate-things.json
{
    "Resources" : {
        "HelloT2micro" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "InstanceType" : "t2.micro",
                "ImageId" : "ami-4836a428",
                "KeyName": "MyKeyPair",
                "Tags" : [ {"Key":"Name", "Value":"El tagerino"} ]
            }
        }
    }
}
</code></pre>
<p>These are some of the options you can set when you're using the AWS gui. Now you can say goodbye to slow page loads and mouse clicks on menus. To start your instance</p>
<pre><code>$ aws cloudformation deploy \
    --template-file automate-things.json \
    --stack-name ec2only
</code></pre>
<p>If all goes well, you should be able to go to your AWS console's CloudFormation panel and see the resource spin up.</p>
<p>If you try to connect to it you'll notice you don't have access.</p>
<pre><code>$ ssh -i MyKeyPair.pem ec2-user@&lt;public ip address&gt;
</code></pre>
<p>And that's because you have the key pair, but no security group. But that's easy to add. Note that we create the security group and update the EC2 instance definition.</p>
<pre><code>// automation-things.json
{
    "Resources" : {
        "HelloT2micro" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "InstanceType" : "t2.micro",
                "ImageId" : "ami-4836a428",
                "SecurityGroups": [ "the-money-sg" ],
                "KeyName": "MyKeyPair",
                "Tags" : [ {"Key":"Name", "Value":"El tagerino"} ]
            }
        },
        "HelloSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "the-money-sg",
                "GroupDescription": "Equal access for all",
                "SecurityGroupIngress": [ {
                    "IpProtocol": "tcp",
                    "FromPort": "22",
                    "ToPort": "22",
                    "CidrIp": "0.0.0.0/0"
                } ]
            }
        }
    }
}
</code></pre>
<p>Now, without tearing down the old instance, we use the same deploy command</p>
<pre><code>$ aws cloudformation deploy \
    --template-file automate-things.json \
    --stack-name ec2only
</code></pre>
<p>You will see in the CloudFormation console that the stack is updating.</p>
<pre><code>$ ssh -i bar.pem ec2-user@35.167.202.35
... # skipped a few lines

       __|  __|_  )
       _|  (     /   Amazon Linux AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/
6 package(s) needed for security, out of 6 available
Run "sudo yum update" to apply all updates.
[ec2-user@ip-172-31-21-130 ~]$
</code></pre>
<p>And you can connect to the instance. That's an easy demo, but I promised a little IAM so I'll add a bucket to show this.</p>
<pre><code>// automate-things.json
{
    "Resources" : {
        "HelloT2micro" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "InstanceType" : "t2.micro",
                "ImageId" : "ami-4836a428",
                "SecurityGroups": [ "the-money-sg" ],
                "KeyName": "MyKeyPair",
                "Tags" : [ {"Key":"Name", "Value":"El tagerino"} ]
            }
        },
        "HelloSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "the-money-sg",
                "GroupDescription": "Equal access for all",
                "SecurityGroupIngress": [ {
                    "IpProtocol": "tcp",
                    "FromPort": "22",
                    "ToPort": "22",
                    "CidrIp": "0.0.0.0/0"
                } ]
            }
        },
        "HelloBucket" : {
            "Type" : "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "treehorn12345"
            }
        }
    }
}
</code></pre>
<p>Run the same deploy command as above.</p>
<p>Ok so we have a bucket and an EC2 instance. You'll notice that if you log in to the EC2 instance you can't see anything in the bucket. </p>
<pre><code>[ec2-user@ip-172-31-21-130 ~]$ aws s3 ls
Unable to locate credentials. You can configure credentials by running "aws configure".
</code></pre>
<p>That is a good thing. If someone hacks into the instance you don't want them to also have access to your data.</p>
<p>Ok, so how do we manage these permissions? Should we add a user? or a group? No! IAM has this thing called roles. And the way they work is like hats. The role can be assumed by any user or group or, in this case, a resource. You can easily have a resource assume a role when it needs extra permissions and revoke the role once it's done. Ok enough theory let's see something happen.</p>
<p>We'll need to create the role. In this case we'll just add it to our template.</p>
<pre><code>// automate-things.json
{
    "Resources" : {
        "HelloT2micro" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "InstanceType" : "t2.micro",
                "ImageId" : "ami-4836a428",
                "SecurityGroups": [ "the-money-sg" ],
                "KeyName": "MyKeyPair",
                "Tags" : [ {"Key":"Name", "Value":"El tagerino"} ]
            }
        },
        "TheMoney": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "the-money-sg",
                "GroupDescription": "Equal access for all",
                "SecurityGroupIngress": [ {
                    "IpProtocol": "tcp",
                    "FromPort": "22",
                    "ToPort": "22",
                    "CidrIp": "0.0.0.0/0"
                } ]
            }
        },
        "HelloBucket" : {
            "Type" : "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "treehorn12345"
            }
        },
        "HelloIAM" : {
            "Type" : "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [ {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "ec2.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    } ]
                },
                "Path": "/",
                "Policies": [ {
                    "PolicyName": "lebowski",
                    "PolicyDocument": {
                        "Statement": [ {
                            "Effect": "Allow",
                            "Action": [
                                "s3:ListAllMyBuckets",
                                "s3:ListBucket"
                            ],
                            "Resource": "*"
                        } ]
                    }
                } ]
            }
        }
    }
}
</code></pre>
<p>We have added an IAM role that says,</p>
<ul>
<li>The principal must be an EC2 instance</li>
<li>The policies allowed are the listing of buckets</li>
</ul>
<p>But you will get an error when you try to deploy. You need to adjust your deploy command to this</p>
<pre><code>$ aws cloudformation deploy \
    --template-file automate-things.json \
    --stack-name ec2only \
    --capabilities CAPABILITY_IAM
</code></pre>
<p>Ok we're done, let's run it. You can try the <code>aws s3 ls</code> command to list all the buckets, but you will get the same <code>Unable to find credentials</code> message as before. </p>
<p>We are telling AWS that this role is only to be used by EC2 instances. But you have to add something else called an InstanceProfile. For more information on how that works, see the documentation. Long story short, your instance needs to have an InstanceProfile that tells it what roles it has available. This way you can assign it more roles as needed.</p>
<pre><code>// automate-things.json
// add the InstanceProfile
</code></pre>
<p>Now when you run this you can log in to your EC2, you can see your bucket and your EC2 can see your bucket.</p>
<pre><code>$ aws s3 ls
# list of buckets
</code></pre>
<p>This concludes our demo for today.</p>
            <!--
            -->
	    </div>
	</div>
    </div>

    <footer class="footer">
      <div class="container">
	  <div class="row">
	    <div class="col-xs-4">
		<p class="text-muted"><span class="glyphicon glyphicon-copyright-mark"></span> M. Hemken 2017</p>
	    </div>
	    <div class="col-xs-4">
                <p class="text-muted"><a href=""><span class="glyphicon glyphicon-download"></span> Resume</a></p>
	    </div>
	    <div class="col-xs-4"></div>
	  </div>
      </div>
    </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <script src="/static/jquery/jquery.min.js"></script>
    <script src="/static/bootstrap/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
  </body>
</html>